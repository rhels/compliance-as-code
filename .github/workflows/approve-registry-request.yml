name: Manual Registry Approval

on:
  issue_comment:
    types: [created]

jobs:
  approve:
    name: Process Manual Approval
    if: |
      contains(github.event.issue.labels.*.name, 'needs-human-review') &&
      contains(github.event.comment.body, '/approve-registry')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Verify approver
        uses: actions/github-script@v7
        with:
          script: |
            const approver = context.payload.comment.user.login;
            // Authorized approvers â€” add GitHub usernames here
            const allowedApprovers = ['konda-rhels', 'kubeclaw-bot'];

            if (!allowedApprovers.includes(approver)) {
              const body = `:no_entry: **${approver}** is not authorized to approve registry requests.\n\nAuthorized approvers: ${allowedApprovers.join(', ')}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              core.setFailed(`User ${approver} is not authorized`);
            }

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Parse issue form fields
        id: parse
        uses: stefanbuck/github-issue-parser@v3
        with:
          template-path: .github/ISSUE_TEMPLATE/image-registry-request.yml

      - name: Generate PR
        env:
          REGISTRY_PATTERN: ${{ steps.parse.outputs.issueparser_registry_pattern }}
          VENDOR_NAME: ${{ steps.parse.outputs.issueparser_vendor_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "ShieldBot"
          git config user.email "shieldbot@rhels.com"
          chmod +x scripts/generate-registry-pr.sh
          ./scripts/generate-registry-pr.sh "$REGISTRY_PATTERN" "$ISSUE_NUMBER" "$VENDOR_NAME"

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue.number;
            const { owner, repo } = context.repo;

            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: issue, name: 'needs-human-review' });
            } catch(e) { /* label may not exist */ }

            await github.rest.issues.addLabels({ owner, repo, issue_number: issue, labels: ['evaluation-passed', 'pr-generated'] });

            await github.rest.issues.createComment({
              owner, repo, issue_number: issue,
              body: `:white_check_mark: **Manually approved** by @${context.payload.comment.user.login}. PR generated.`
            });
